#lab2

##练习1：实现 first-fit 连续物理内存分配算法（需要编程）

###算法设计
first-fit算法中，所有空闲块按照起始地址排序形成链表。在分配时顺序遍历链表直到找到第一个可用的空闲块，分配所需页数，若有多余则切下作为新的内存块。在回收时，检查如果有相邻内存块则合并。

###算法实现
1.default_init：沿用原始实现不用修改  
2.default_init_memmap：first-fit算法的空闲块按照地址顺序排列，因此每次需要把新的内存块插入链表的尾部  
3.default_alloc_pages：从初始节点开始顺序遍历链表，直到找到第一块满足需求的空闲块，修改Property，将剩余的页组织成新的空闲块插入链表  
4.default_free_pages：将标志位清空，顺序查找到插入链表的位置，如果前后有相邻空闲块，则合并

###改进空间
first-fit算法中，每次都从链表起始位置开始搜索，可能导致低地址空间有过多碎片

##练习2：实现寻找虚拟地址对应的页表项（需要编程）

###算法设计和实现
需修改get_pte函数，主要实现填写页目录表，和建立页表，返回页表项地址。  
1.首先获取页目录表项，检查对应页表是否存在，若存在，转4  
2.若页表不存在，调用alloc_page分配新页并初始化  
3.将新页地址填入页目录表项，设置标志位  
4.返回页表项地址  

###页目录项（Pag Director Entry）和页表（Page Table Entry）中每个组成部分的含义和以及对ucore而言的潜在用处

页目录项组成：
>页表地址(20bit)|OS专用(3bit)|0|PSE|0|A|PCD|PWT|U/S|W/R|P

页表项组成：
>物理页帧号(20bit)|OS专用(3bit)|0|D|0|A|PCD|PWT|U/S|W/R|P

 P：存在（Present）标志，用于指明此表项是否有效。P=1表示有效；P=0表示无效。用于指示是否页缺失。  
 R/W：读/写（Read/Write）标志，如果R/W=1，表示页的内容可以被读、写或执行。如果R/W=0，表示页的内容只读或可执行。当处理器运行在特权级（级别0、1或2）时，则R/W位不起作用。  
 U/S：是用户态/特权态（User/Supervisor）标志。如果U/S=1，那么在用户态和特权态都可以访问该页。如果U/S=0，那么只能在特权态（0、1或2）可访问该页。  
 A：是已访问（Accessed）标志。当CPU访问页表项映射的物理页时，页表项的这个标志就会被置为1。ucore可通过该标志来统计页的使用情况，用于页替换策略。  
 D：是页面已被修改（Dirty）标志。当CPU写页表项映射的物理页内容时，页表项的这个标志就会被置为1。ucore可通过该标志来统计页的修改情况，用于页替换策略，并控制页换出时是否需要写回。  

###如果ucore执行过程中访问内存，出现了页访问异常，硬件要做哪些事情
产生页访问异常的原因主要有：目标页帧不存在；相应的物理页帧不在内存中；不满足访问权限。
产生页访问异常后，CPU把产生异常的线性地址存储在CR2中。  
与其他异常处理过程相同，CPU保存当前被打断的程序现场，即依次压入当前被打断程序使用的EFLAGS，CS，EIP，errorCode，然后把对应的中断服务例程的地址加载到CS和EIP寄存器中，开始执行中断服务例程。

##练习3：释放某虚地址所在的页并取消对应二级页表项的映射（需要编程）

###算法设计和实现
需实现page_remove_pte函数。  
1.首先检查对应物理页是否存在，若不存在直接返回  
2.找到对应物理页  
3.修改该页引用次数，若为0，则调用free_page  
4.清空页表项  
5.更新tlb  

###数据结构Page的全局变量（其实是一个数组）的每一项与页表中的页目录项和页表项有无对应关系？如果有，其对应关系是啥？
有对应关系。  
在建立映射关系后，页表项中储存的物理页号对应Page数组的index。

###如果希望虚拟地址与物理地址相等，则需要如何修改lab2，完成此事？ 鼓励通过编程来具体完成这个问题
原始虚拟内存空间为0xC0000000~0xF8000000，欲使虚拟地址与物理地址相等，则需要平移此空间到0x00000000~0x38000000。
1.修改tools/kernel.ld中的链接地址
```
/* Load the kernel at this address: "." means the current address */
. = 0x00100000;
```
2.修改kern/mm/memlayout.h中的KERNBASE
```
#define KERNBASE            0x00000000
#define VPT                       0x3AC00000
```
3.取消kern/mm/pmm.c中将boot_pgdir[0]置零的操作
```
//boot_pgdir[0] = 0;
```

##与参考答案的区别
练习1：参考答案将每一个空闲页都加入了链表，我的实现只将空闲块的起始页加入链表。
练习2：基本一致。
练习3：基本一致。

##本实验中重要的知识点
###页式存储管理
页式存储将虚拟地址与物理地址都划分成相同大小的页，并建立映射关系，因此不再要求存储的连续性。
###多级页表
实验中采用二级页表，其实现原理与OS原理讲述相同。多级页表可以减少页表占据的内存空间。
###内存分配算法
实验中主要涉及了first-fit算法，其实现原理与OS原理讲述相同，需要额外注意链表项、页结构与对应物理地址的相互转换。

##OS原理中很重要，但在实验中没有对应上的知识点
###tlb
tlb用于迅速实现虚拟地址与物理地址的转换，实验中并没有涉及页替换时对于tlb的修改。
###反置页表
反置页表只与物理空间大小有关，在虚拟地址空间远大于物理空间时，可以减少页表空间，提高访存性能。
